<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cold Signal — SF Horror Mystery</title>
  <meta name="description" content="A minimalist SF horror mystery you can host on GitHub Pages. Investigate, gather clues, and survive." />
  <style>
    :root{
      --bg:#05080c; --fg:#e7eef6; --muted:#8aa0b1; --card:#0c1218; --accent:#87b7ff; --accent-2:#eab308; --btn:#111a22; --btn-hover:#162230;
    }
    :root.light{
      --bg:#f7fafc; --fg:#0b0f14; --muted:#52606d; --card:#ffffff; --accent:#2563eb; --accent-2:#f59e0b; --btn:#eef2f7; --btn-hover:#e5eaf1;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;display:grid;place-items:center}
    .app{width:min(900px,95vw);padding:24px}
    .frame{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-weight:800;letter-spacing:.3px;display:flex;align-items:center;gap:10px}
    .badge{background:var(--btn);color:var(--muted);padding:3px 8px;border-radius:999px;font-size:12px}
    .toolbar{display:flex;gap:8px;align-items:center}
    button{background:var(--btn);color:var(--fg);border:1px solid rgba(255,255,255,.08);padding:10px 14px;border-radius:10px;cursor:pointer;transition:background .15s ease,transform .05s ease}
    button:hover{background:var(--btn-hover)}
    button:active{transform:translateY(1px)}
    .screen{min-height:240px;padding:18px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px dashed rgba(255,255,255,.08)}
    .scene-title{font-weight:700;font-size:20px;margin:0 0 8px}
    .scene-text{margin:0 0 16px;color:var(--fg)}
    .choices{display:grid;gap:10px}
    .choice{display:flex;justify-content:space-between;align-items:center}
    .choice small{color:var(--muted)}
    .progress{height:8px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden;margin:16px 0 6px}
    .progress>div{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .3s ease}
    .meta{display:flex;justify-content:space-between;color:var(--muted);font-size:12px}
    .footer{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
    .hidden{display:none}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="app">
    <div class="frame">
      <header>
        <div class="title">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 7l9-4 9 4-9 4-9-4z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M3 12l9 4 9-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 17l9 4 9-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>Cold Signal</span>
          <span class="badge">v1.0</span>
        </div>
        <div class="toolbar">
          <button id="themeBtn" title="Toggle theme">🌗 Theme</button>
          <button id="restartBtn" title="Restart">🔁 Restart</button>
          <button id="shareBtn" title="Copy URL with progress">🔗 Share</button>
        </div>
      </header>

      <div class="progress"><div id="bar"></div></div>
      <div class="meta"><span id="pathMeta">Path: —</span><span id="stepMeta">0 steps</span></div>

      <main class="screen" role="region" aria-live="polite">
        <h2 id="sceneTitle" class="scene-title"></h2>
        <p id="sceneText" class="scene-text"></p>
        <div id="choices" class="choices"></div>
        <div id="endScreen" class="hidden">
          <p>🎉 The End. You can <button id="tryAgainBtn">try again</button> or <a href="#" id="exportLink">export your path</a>.</p>
        </div>
      </main>

      <div class="footer">
        <button id="backBtn">⬅️ Back</button>
        <button id="forwardBtn">➡️ Forward</button>
        <button id="saveBtn">💾 Save</button>
        <button id="loadBtn">📂 Load</button>
      </div>

      <p class="meta">SF Horror Mystery edition. Host this single file on GitHub Pages. Edit the <code>story</code> data below to write your own branches.</p>
    </div>
  </div>

  <script>
    // ---- Story data: SF Horror Mystery ----
    const story = {
      start: {
        title: "Docking at SEVEN‑IX",
        text: "Your cutter latches to the silent research station SEVEN‑IX. A looping distress ping—the 'cold signal'—bleeds through comms. Where do you start?",
        choices: [
          { label: "Operations (comms)", to: "ops" },
          { label: "Medbay (specimens)", to: "med" },
        ],
      },

      ops: {
        title: "Operations Deck",
        text: "Dead consoles twitch. A carrier tone repeats every 13 seconds. Dust hangs like ash.",
        choices: [
          { label: "Play last crew log", to: "log", set: { clues: +1 } },
          { label: "Trace the cold signal to Sublevel Cargo", to: "cargo_entry", set: { trace: true } },
          { label: "Restore auxiliary power", to: "generator" },
          { label: "Back to airlock", to: "start" },
        ],
      },

      generator: {
        title: "Auxiliary Junction",
        text: "Manual breakers resist, then give. Emergency strips glow to life. Systems hum—something hums back.",
        choices: [
          { label: "Return to Operations", to: "ops", set: { aux: true } },
        ],
      },

      log: {
        title: "Last Log Playback",
        text: "Voices argue over 'Specimen 13.' —‘It reacts to infrared. Keep the UV on.’ The recording cuts with scraping metal.",
        choices: [
          { label: "Head to Medbay", to: "med" },
          { label: "Check Crew Quarters for a keycard", to: "quarters" },
          { label: "Back to Operations", to: "ops" },
        ],
      },

      quarters: {
        title: "Crew Quarters",
        text: "Photos taped over vents. A locker blinks low‑power. The nameplate reads: K. Nasiri.",
        choices: [
          { label: "Open locker (find keycard)", to: "quarters_found", set: { key: true, clues: +1 } },
          { label: "Return to corridor", to: "start" },
        ],
      },

      quarters_found: {
        title: "Keycard Acquired",
        text: "A Level‑C cargo keycard and a handwritten note: 'If it hums, do not breathe.'",
        choices: [
          { label: "Proceed to Sublevel Cargo", to: "cargo_entry" },
          { label: "Back to Operations", to: "ops" },
        ],
      },

      med: {
        title: "Medbay",
        text: "Cryopod 13 is empty. Frost prints end beneath a vent. Cabinets yaw open.",
        choices: [
          { label: "Search supplies (find UV scanner)", to: "med_uv", set: { uv: true, clues: +1 } },
          { label: "Run autopsy console", to: "autopsy", if: s => s.aux },
          { label: "Follow sticky prints toward Cargo", to: "cargo_entry", if: s => s.uv },
          { label: "Back to airlock", to: "start" },
        ],
      },

      med_uv: {
        title: "UV Scanner Online",
        text: "Under ultraviolet, filament trails blink like constellations leading downward.",
        choices: [
          { label: "Go to Cargo", to: "cargo_entry" },
          { label: "Check autopsy console (needs power)", to: "autopsy", if: s => s.aux },
          { label: "Back to Medbay", to: "med" },
        ],
      },

      autopsy: {
        title: "Autopsy Records",
        text: "Report fragments: 'Specimen avoids UV, resonates to 13Hz carrier, breaches soft tissue via aerosols.'",
        choices: [
          { label: "Proceed to Cargo", to: "cargo_entry", set: { clues: +1 } },
          { label: "Back to Medbay", to: "med" },
        ],
      },

      cargo_entry: {
        title: "Sublevel Cargo Bulkhead",
        text: "A sealed Level‑C door. Air tastes metallic. A faint hum counts seconds.",
        choices: [
          { label: "Swipe keycard", to: "cargo_hall", if: s => s.key },
          { label: "Pry service hatch (risky)", to: "hatch", set: { fear: +1 } },
          { label: "UV sweep the vents", to: "hatch", if: s => s.uv },
          { label: "Back to Operations", to: "ops" },
        ],
      },

      hatch: {
        title: "Maintenance Crawl",
        text: "Pipes sweat. Something retracts just ahead, clicking like teeth. The hum grows warmer.",
        choices: [
          { label: "Push through to containment hall", to: "cargo_hall" },
          { label: "Retreat", to: "cargo_entry" },
        ],
      },

      cargo_hall: {
        title: "Containment Hall",
        text: "Cracked viewport. Inside, a wet silhouette studies its own reflection—then turns to the hum.",
        choices: [
          { label: "Stage a quarantine trap (needs power + key)", to: "boss", if: s => s.aux && s.key },
          { label: "Record evidence and broadcast (needs 3 clues)", to: "boss", if: s => (s.clues||0) >= 3 },
          { label: "Use UV to drive it toward the airlock", to: "boss", if: s => s.uv },
          { label: "Run", to: "end_lost" },
        ],
      },

      boss: {
        title: "Specimen 13 Stirs",
        text: "It sways to the carrier tone. Veins glitter under your UV. Your visor fogs from your own breath.",
        choices: [
          { label: "Seal containment and flood inert gas", to: "end_quarantine", if: s => s.aux && s.key, set: { ending: "Quarantine" } },
          { label: "Drive it into the docking airlock and vent", to: "end_vent", if: s => s.uv, set: { ending: "Vented" } },
          { label: "Broadcast proof to public channels", to: "end_broadcast", if: s => (s.clues||0) >= 3, set: { ending: "Broadcast" } },
        ],
      },

      end_quarantine: { end:true, title: "Containment Holds",
        text: "Gas hisses. The silhouette stills against glass. Your report is clean; your hands are not.", choices: [] },

      end_vent: { end:true, title: "Cold Stars, Colder Ship",
        text: "You vent the bay. The hum fades into vacuum. Something hums back in your teeth.", choices: [] },

      end_broadcast: { end:true, title: "Everyone Hears the Hum",
        text: "The truth spreads before the quarantine teams arrive. Your cough starts on the seventh word.", choices: [] },

      end_lost: { end:true, title: "Signal Continues",
        text: "You flee through blue corridors. Behind you, the cold signal keeps perfect time.", choices: [] },
    };

    // --- Engine state (unchanged) ---
    const elTitle = document.getElementById('sceneTitle');
    const elText = document.getElementById('sceneText');
    const elChoices = document.getElementById('choices');
    const elEnd = document.getElementById('endScreen');
    const elBar = document.getElementById('bar');
    const elPathMeta = document.getElementById('pathMeta');
    const elStepMeta = document.getElementById('stepMeta');

    const state = { node:'start', flags:{}, history:['start'], future:[] };

    const themeBtn = document.getElementById('themeBtn');
    function applyTheme(){ const light = localStorage.getItem('theme') === 'light'; document.documentElement.classList.toggle('light', light); }
    themeBtn.addEventListener('click', ()=>{ const cur = localStorage.getItem('theme') === 'light' ? 'dark':'light'; localStorage.setItem('theme', cur); applyTheme(); });
    applyTheme();

    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    function setNode(id){ state.node=id; state.future=[]; if(!state.history.length||state.history[state.history.length-1]!==id){ state.history.push(id);} render(); saveToURL(); }

    function applySet(set){ if(!set) return; const s=state.flags; for(const [k,v] of Object.entries(set)){ if(typeof v==='number') s[k]=(s[k]||0)+v; else s[k]=v; } }

    function visibleChoices(node){ return (node.choices||[]).filter(c=>!c.if||c.if(state.flags)); }

    function render(){
      const node = story[state.node];
      elTitle.textContent = node.title || '';
      elText.textContent = node.text || '';
      elChoices.innerHTML='';
      const totalSteps = Object.keys(story).length;
      const pct = clamp((state.history.length/totalSteps)*100,5,100);
      elBar.style.width = pct + '%';
      elPathMeta.textContent = 'Path: ' + state.history.join(' → ');
      elStepMeta.textContent = state.history.length + ' steps';
      if(node.end){ elChoices.classList.add('hidden'); elEnd.classList.remove('hidden'); return; } else { elChoices.classList.remove('hidden'); elEnd.classList.add('hidden'); }
      for(const choice of visibleChoices(node)){
        const btn=document.createElement('button'); btn.innerHTML=`<span>${choice.label}</span>`; btn.addEventListener('click',()=>{ applySet(choice.set); setNode(choice.to); });
        const row=document.createElement('div'); row.className='choice'; const hint=document.createElement('small'); hint.textContent = choice.if ? 'requires condition' : ''; row.appendChild(btn); row.appendChild(hint); elChoices.appendChild(row);
      }
    }

    document.getElementById('backBtn').addEventListener('click',()=>{ if(state.history.length>1){ const cur=state.history.pop(); state.future.push(cur); state.node=state.history[state.history.length-1]; render(); saveToURL(); }});
    document.getElementById('forwardBtn').addEventListener('click',()=>{ if(state.future.length){ const next=state.future.pop(); state.history.push(next); state.node=next; render(); saveToURL(); }});

    function serialize(){ return JSON.stringify({ node:state.node, flags:state.flags, history:state.history, future:state.future }); }
    function deserialize(s){ try{ const obj=JSON.parse(s); Object.assign(state,obj); render(); } catch{ alert('Invalid save data'); } }
    document.getElementById('saveBtn').addEventListener('click',()=>{ localStorage.setItem('coldsignal_save', serialize()); alert('Saved!'); });
    document.getElementById('loadBtn').addEventListener('click',()=>{ const data=localStorage.getItem('coldsignal_save'); if(data) deserialize(data); else alert('No save data found.'); });

    document.getElementById('restartBtn').addEventListener('click',()=>{ state.node='start'; state.flags={}; state.history=['start']; state.future=[]; render(); saveToURL(); });
    document.getElementById('tryAgainBtn').addEventListener('click',()=>{ state.node='start'; state.history=['start']; state.future=[]; render(); saveToURL(); });

    function saveToURL(){ const encoded=btoa(unescape(encodeURIComponent(serialize()))); const url=new URL(location.href); url.hash=encoded; history.replaceState(null,'',url); document.getElementById('exportLink').href=url.toString(); }
    function loadFromURL(){ if(location.hash && location.hash.length>1){ const data=decodeURIComponent(escape(atob(location.hash.slice(1)))); deserialize(data); } else { render(); saveToURL(); } }

    window.addEventListener('keydown',(e)=>{ const keys=['1','2','3','4','5','6','7','8','9']; if(keys.includes(e.key)){ const i=Number(e.key)-1; const btns=elChoices.querySelectorAll('button'); if(btns[i]) btns[i].click(); } if(e.key==='ArrowLeft') document.getElementById('backBtn').click(); if(e.key==='ArrowRight') document.getElementById('forwardBtn').click(); });

    document.getElementById('shareBtn').addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(location.href); alert('URL copied!'); } catch{ alert('Copy failed — use the Export link at the end.'); } });

    loadFromURL();
  </script>
</body>
</html>
